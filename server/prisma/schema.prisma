generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id             String            @id @default(cuid())
  username       String            @unique
  passwordHash   String
  createdAt      DateTime          @default(now())
  updatedAt      DateTime          @updatedAt

  sentMessages   Message[]         @relation("SentMessages")
  chatParticipants ChatParticipant[]
  memorySettings MemorySettings?
}

model Chat {
  id           String            @id @default(cuid())
  title        String?
  metadata     Json?
  createdAt    DateTime          @default(now())
  updatedAt    DateTime          @updatedAt

  messages     Message[]
  participants ChatParticipant[]
}

model ChatParticipant {
  id     String @id @default(cuid())
  userId String
  chatId String

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  chat Chat @relation(fields: [chatId], references: [id], onDelete: Cascade)

  @@unique([userId, chatId])
}

model Message {
  id        String   @id @default(cuid())
  content   String
  createdAt DateTime @default(now())

  senderId  String
  chatId    String

  sender User @relation("SentMessages", fields: [senderId], references: [id], onDelete: Cascade)
  chat   Chat @relation(fields: [chatId], references: [id], onDelete: Cascade)

  //  --- DODANE ---
  // Relacja wskazujca, 偶e wiadomo mo偶e mie wiele zacznik贸w.
  attachments Attachment[]
}

//  --- DODANY CAY MODEL ---
// Reprezentuje pojedynczy plik zaczony do wiadomoci.
model Attachment {
  id        String   @id @default(cuid())
  url       String   // URL do pliku w chmurze (np. AWS S3)
  filename  String   // Oryginalna nazwa pliku
  mimetype  String   // Typ MIME, np. "image/png" czy "application/pdf"
  size      Int      // Rozmiar pliku w bajtach
  createdAt DateTime @default(now())

  // Relacja zwrotna do wiadomoci
  messageId String
  message   Message  @relation(fields: [messageId], references: [id], onDelete: Cascade)
}

//  --- PAMI WEKTOROWA ---
// G贸wna tabela przechowujca wpisy pamici wektorowej
model VectorMemory {
  id              String   @id @default(cuid())
  content         String   // Oryginalny tekst wiadomoci
  embedding       Float[]  // Wektor embeddings (PostgreSQL wspiera array)
  importanceScore Float    @default(0.5) // Ocena wa偶noci 0-1
  timestamp       DateTime @default(now())
  
  // Relacje
  userId          String
  chatId          String
  messageId       String?  // Opcjonalne - mo偶e by null dla zagregowanych wspomnie
  
  // Kontekst i metadane
  context         String?  // Kilka poprzednich wiadomoci jako kontekst
  tags            String[] // Automatycznie generowane tagi
  metadata        Json?    // Dodatkowe metadane (model u偶yty, typ interakcji, itp.)
  
  // Indeksy dla wydajnoci
  @@index([userId])
  @@index([chatId])  
  @@index([timestamp])
  @@index([importanceScore])
}

// Tabela do przechowywania konfiguracji u偶ytkownika dla pamici
model MemorySettings {
  id                    String  @id @default(cuid())
  userId                String  @unique
  importanceThreshold   Float   @default(0.3) // Pr贸g wa偶noci dla zapisywania
  maxMemoryEntries      Int     @default(10000) // Maksymalna liczba wpis贸w
  retentionDays         Int     @default(365) // Ile dni przechowywa wpisy
  autoCleanupEnabled    Boolean @default(true)
  
  // Nowe opcje prywatnoci
  memoryEnabled         Boolean @default(true) // Czy w og贸le zapisywa do pamici
  autoDeleteOnChatRemoval Boolean @default(true) // Czy automatycznie usuwa pami przy usuwaniu czatu
  incognitoMode         Boolean @default(false) // Tryb incognito - nie zapisuj nic
  shareMemoryAcrossChats Boolean @default(true) // Czy dzieli pami midzy r贸偶nymi czatami
  memoryAggressiveness  String  @default("conservative") // Poziom agresywnoci: conservative/moderate/aggressive
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}